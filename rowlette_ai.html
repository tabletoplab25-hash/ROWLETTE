<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ° Rowlette â€” Standalone (IT/EN) â€¢ Leaderboard Jackpot â€¢ Balanced Zeros â€¢ Specials</title>
  <style>
    *{box-sizing:border-box}html,body{margin:0;padding:0}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial;background:linear-gradient(135deg,#0ea5e9 0%,#7c3aed 100%);color:#fff;min-height:100vh;padding:20px}
    .container{max-width:1200px;margin:0 auto}
    .title{font-size:2.4rem;font-weight:900;margin:0}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .lang{background:rgba(255,255,255,.16); border:1px solid rgba(255,255,255,.25); padding:6px 10px; border-radius:999px}
    .subtitle{text-align:center;opacity:.9;margin:6px 0 16px}
    .panel{background:rgba(0,0,0,.28);border:1px solid rgba(255,255,255,.15);border-radius:16px;padding:16px;backdrop-filter:blur(8px)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .btn{border:0;border-radius:10px;padding:.6rem 1rem;font-weight:700;cursor:pointer;transition:.15s all}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-primary{background:#10b981;color:#fff}.btn-primary:hover{filter:brightness(1.08)}
    .btn-secondary{background:#f59e0b;color:#111}.btn-secondary:hover{filter:brightness(1.08)}
    .btn-danger{background:#ef4444;color:#fff}.btn-danger:hover{filter:brightness(1.08)}
    .grid{display:grid;gap:16px}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .market{margin-top:8px}
    .card{background:rgba(255,255,255,.92);color:#111;border-radius:12px;min-height:92px;display:flex;align-items:center;justify-content:center;flex-direction:column;border:2px solid transparent;cursor:pointer;transition:.15s all}
    .card:hover{transform:translateY(-4px);border-color:#fbbf24;box-shadow:0 10px 20px rgba(0,0,0,.15)}
    .card .ico{font-size:1.8rem}
    .card .val{font-weight:800;font-size:1.1rem}
    .badge{display:inline-block;padding:.2rem .5rem;border-radius:999px;background:rgba(255,255,255,.18);margin-left:6px}
    .player{background:rgba(0,0,0,.22);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:12px}
    .player.current{border-color:#fbbf24;box-shadow:0 0 0 2px rgba(251,191,36,.25)}
    .player.exploded{opacity:.78;border-color:#ef4444}
    .player.stopped{opacity:.65}
    .player .name{font-weight:800;font-size:1.05rem}
    .stat{background:rgba(255,255,255,.14);padding:.25rem .5rem;border-radius:999px;margin-left:6px}
    .mini{display:flex;flex-wrap:wrap;gap:6px}
    .mini .pill{background:rgba(255,255,255,.16);padding:.25rem .45rem;border-radius:6px;font-size:.8rem}
    .log{max-height:60vh;overflow:auto}
    .modal,.overlay{position:fixed;inset:0;display:none}
    .overlay{background:rgba(0,0,0,.5);z-index:20}
    .modal{z-index:30;align-items:center;justify-content:center;padding:16px}
    .modal .box{background:#fff;color:#111;border-radius:16px;padding:16px;max-width:560px;width:100%}
    .hidden{display:none}
    .toast{position:fixed;left:50%;top:22px;transform:translateX(-50%);z-index:40;background:#fff;color:#111;border-radius:999px;padding:.6rem 1rem;border:2px solid #22c55e;box-shadow:0 10px 20px rgba(0,0,0,.2);display:none}
    .errorbar{position:fixed;left:0;right:0;top:0;background:#ef4444;color:#fff;font-weight:700;padding:8px 12px;display:none;z-index:50}
    @media (max-width:900px){.grid-2{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="errorbar" id="errorbar"></div>
  <div class="container">
    <div class="topbar">
      <h1 class="title">ğŸ° ROWLETTE</h1>
      <div class="lang">
        <label><input type="radio" name="lang" value="it"> IT</label>
        <label style="margin-left:8px"><input type="radio" name="lang" value="en" checked> EN</label>
      </div>
    </div>
    <div id="subtitle" class="subtitle">Family push-your-luck â€¢ 3-card market â€¢ goals ğŸ¯ â€¢ jackpot ğŸ’° â€¢ zeros ğŸ’š (MIN/MAX/YOU)</div>

    <!-- LOBBY -->
    <div id="lobby" class="panel">
      <h2 id="setupTitle">ğŸ® Player setup</h2>
      <div style="height:8px"></div>
      
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:12px">
        <div>
          <label id="playerNameLabel">Your name</label>
          <input id="playerNameInput" type="text" value="You" placeholder="Your name" style="width:100%; padding:.6rem; border-radius:10px; border:0; background:rgba(255,255,255,.12); color:#fff; margin-bottom:8px">
        </div>
        <div>
          <label id="aiCountLabel">AI opponents</label>
          <select id="aiCountSelect" style="width:100%; padding:.6rem; border-radius:10px; border:0; background:rgba(255,255,255,.12); color:#fff; margin-bottom:8px">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
          </select>
        </div>
        <div>
          <label id="difficultyLabel">Difficulty</label>
          <select id="difficultySelect" style="width:100%; padding:.6rem; border-radius:10px; border:0; background:rgba(255,255,255,.12); color:#fff; margin-bottom:8px">
            <option value="easy">Easy ğŸŸ¢</option>
            <option value="hard">Hard ğŸ”´</option>
          </select>
        </div>
      </div>
      
      <div class="row" style="margin-top:12px">
        <button id="btnStart" class="btn btn-primary" type="button">ğŸš€ Start</button>
      </div>
    </div>

    <!-- GAME -->
    <div id="game" class="panel hidden">
      <div class="row" style="align-items:center;justify-content:space-between">
        <div>Round <span id="roundEl">1</span>/3 <span class="badge" id="deckLabel">Deck <span id="deckCount">0</span></span></div>
        <div class="row" style="align-items:center;gap:8px">
          <div><span id="turnLabel">Turn</span>: <b id="activeName"></b></div>
          <button id="btnStop" class="btn btn-secondary" type="button">âœ‹ Stop player</button>
          <button id="btnEndRound" class="btn btn-danger" type="button">ğŸ End round</button>
        </div>
      </div>

      <!-- Market -->
      <div style="height:8px"></div>
      <div class="panel">
        <div class="row" style="align-items:center">
          <h3 id="marketTitle" style="margin-right:8px">ğŸƒ Market: pick 1</h3>
          <small id="marketHint">(others stay)</small>
        </div>
        <div id="market" class="grid grid-3 market"></div>
      </div>

      <!-- Players -->
      <div style="height:12px"></div>
      <div id="playersArea" class="grid grid-2"></div>

      <!-- Log -->
      <div style="height:12px"></div>
      <div class="panel">
        <h3 id="logTitle">ğŸ“œ Log</h3>
        <div id="log" class="log"></div>
      </div>
    </div>

    <!-- MODALS -->
    <div id="overlay" class="overlay"></div>

    <!-- Choose Objective -->
    <div id="objModal" class="modal">
      <div class="box">
        <h3 id="objModalTitle">ğŸ¯ Choose 1 goal (3 random)</h3>
        <div style="height:8px"></div>
        <div id="objChoices" class="grid grid-3"></div>
      </div>
    </div>

    <!-- Round Summary -->
    <div id="summaryModal" class="modal">
      <div class="box">
        <h2 id="summaryTitle">ğŸ¯ End of Round</h2>
        <div id="summaryList"></div>
        <div class="row" style="margin-top:12px">
          <button id="nextRoundBtn" class="btn btn-primary" type="button">â¡ï¸ Next round</button>
          <button id="newGameBtn" class="btn btn-secondary hidden" type="button" onclick="location.reload()">ğŸ”„ New game</button>
        </div>
      </div>
    </div>

    <!-- Zero toast -->
    <div id="zeroToast" class="toast">ğŸ’š Zero â†’ assigned</div>
  </div>

  <script>
  'use strict';

  // Error banner
  window.addEventListener('error', function(e){
    var bar = document.getElementById('errorbar');
    if(!bar) return;
    bar.textContent = 'JavaScript error: ' + e.message;
    bar.style.display = 'block';
  });

  // i18n
  var lang = 'en';
  var L = {
    it: {
      subtitle: 'Family push-your-luck â€¢ mercato a 3 carte â€¢ obiettivi ğŸ¯ â€¢ jackpot ğŸ’° â€¢ zeri ğŸ’š (MIN/MAX/YOU)',
      setup: 'ğŸ® Setup giocatori', add: '+ Aggiungi', start: 'ğŸš€ Inizia',
      deck: 'Mazzo', turn: 'Turno', stop: 'âœ‹ Stop giocatore', endRound: 'ğŸ Fine round',
      marketTitle: 'ğŸƒ Mercato: scegli 1', marketHint: '(le altre restano)', log: 'ğŸ“œ Log',
      objTitle: 'ğŸ¯ Scegli 1 obiettivo (3 casuali)',
      roundEnd: 'ğŸ¯ Fine Round', nextRound: 'â¡ï¸ Prossimo round',
      toastZero: function(d,t,name,pts,boom){ return 'ğŸ’š '+d+' ('+t+') â†’ '+name+' â€¢ âš¡ '+pts+'/6'+(boom?'  ğŸ’¥ ESPLOSIONE!':''); },
      logStart: function(names){ return 'Partita iniziata: '+names; },
      logPickBlack: function(p,v,j){ return p+' prende âš« '+v+' â†’ ğŸ’° +1 = '+j; },
      logPickRed: function(p,v){ return p+' prende ğŸ”´ '+v+' â†’ sceglie Obiettivo ğŸ¯'; },
      logRemoveZero: function(p,v,t){ return p+' gioca '+v+' â†’ rimuove ultimo ğŸ’š (âˆ’'+t+') e rimischia'; },
      logRaiseCap: function(p,cap){ return p+' aumenta il limite carte a '+cap; },
      logNoZeroToRemove: function(p,v){ return p+' gioca '+v+' â†’ nessun ğŸ’š da rimuovere'; },
      logGainObj: function(p,t,need){ return p+' ottiene ğŸ¯ '+t+' (soglia â‰¥'+need+')'; },
      logStop: function(p){ return 'âœ‹ '+p+' si ferma per questo round'; },
      logZeroBlocked: function(z,target,reason){ return 'ğŸ’š '+z+' ('+target+') â†’ rimischiata (' + reason + ')'; },
      cardsLbl: 'Carte', objsLbl:'Obiettivi',
      objNames: { Rosso:'Rosso', Nero:'Nero', Pari:'Pari', Dispari:'Dispari', Alto:'Alto', Basso:'Basso' },
      specialR0: 'ğŸ”· Rimuovi 0', specialCap: 'ğŸ”· +Limite',
      specialUp: 'ğŸ”· Ordine â–²', specialDown: 'ğŸ”· Ordine â–¼'
    },
    en: {
      subtitle: 'Family push-your-luck â€¢ 3-card market â€¢ goals ğŸ¯ â€¢ jackpot ğŸ’° â€¢ zeros ğŸ’š (MIN/MAX/YOU)',
      setup: 'ğŸ® Player setup', add: '+ Add', start: 'ğŸš€ Start',
      deck: 'Deck', turn: 'Turn', stop: 'âœ‹ Stop player', endRound: 'ğŸ End round',
      marketTitle: 'ğŸƒ Market: pick 1', marketHint: '(others stay)', log: 'ğŸ“œ Log',
      objTitle: 'ğŸ¯ Choose 1 goal (3 random)',
      roundEnd: 'ğŸ¯ End of Round', nextRound: 'â¡ï¸ Next round',
      toastZero: function(d,t,name,pts,boom){ return 'ğŸ’š '+d+' ('+t+') â†’ '+name+' â€¢ âš¡ '+pts+'/6'+(boom?'  ğŸ’¥ BOOM!':''); },
      logStart: function(names){ return 'Game started: '+names; },
      logPickBlack: function(p,v,j){ return p+' takes âš« '+v+' â†’ ğŸ’° +1 = '+j; },
      logPickRed: function(p,v){ return p+' takes ğŸ”´ '+v+' â†’ chooses a Goal ğŸ¯'; },
      logRemoveZero: function(p,v,t){ return p+' plays '+v+' â†’ removes last ğŸ’š (âˆ’'+t+') and shuffles back'; },
      logRaiseCap: function(p,cap){ return p+' increases card limit to '+cap; },
      logNoZeroToRemove: function(p,v){ return p+' plays '+v+' â†’ no ğŸ’š to remove'; },
      logGainObj: function(p,t,need){ return p+' gains ğŸ¯ '+t+' (threshold â‰¥'+need+')'; },
      logStop: function(p){ return 'âœ‹ '+p+' stops for this round'; },
      logZeroBlocked: function(z,target,reason){ return 'ğŸ’š '+z+' ('+target+') â†’ shuffled back (' + reason + ')'; },
      cardsLbl: 'Cards', objsLbl:'Goals',
      objNames: { Rosso:'Red', Nero:'Black', Pari:'Even', Dispari:'Odd', Alto:'High', Basso:'Low' },
      specialR0: 'ğŸ”· Remove 0', specialCap: 'ğŸ”· +Limit',
      specialUp: 'ğŸ”· Order â–²', specialDown: 'ğŸ”· Order â–¼'
    }
  };
  function tObj(name){ return (L[lang].objNames && L[lang].objNames[name]) || name; }
  function setTexts(){
    var el;
    if(el = document.getElementById('subtitle')) el.textContent=L[lang].subtitle;
    if(el = document.getElementById('setupTitle')) el.textContent=L[lang].setup;
    if(el = document.getElementById('btnAdd')) el.textContent=L[lang].add;
    if(el = document.getElementById('btnStart')) el.textContent=L[lang].start;
    if(el = document.getElementById('deckLabel')) el.innerHTML=L[lang].deck+' <span id="deckCount">'+(state.deck?state.deck.length:0)+'</span>';
    if(el = document.getElementById('turnLabel')) el.textContent=L[lang].turn;
    if(el = document.getElementById('btnStop')) el.textContent=L[lang].stop;
    if(el = document.getElementById('btnEndRound')) el.textContent=L[lang].endRound;
    if(el = document.getElementById('marketTitle')) el.textContent=L[lang].marketTitle;
    if(el = document.getElementById('marketHint')) el.textContent=L[lang].marketHint;
    if(el = document.getElementById('logTitle')) el.textContent=L[lang].log;
    if(el = document.getElementById('objModalTitle')) el.textContent=L[lang].objTitle;
    if(el = document.getElementById('summaryTitle')) el.textContent=L[lang].roundEnd;
    if(el = document.getElementById('nextRoundBtn')) el.textContent=L[lang].nextRound;
    
    // Traduzioni per le label IA
    if(el = document.getElementById('playerNameLabel')) el.textContent = (lang==='it'?'Il tuo nome':'Your name');
    if(el = document.getElementById('aiCountLabel')) el.textContent = (lang==='it'?'Numero di avversari IA (1-3)':'AI opponents (1-3)');
    if(el = document.getElementById('difficultyLabel')) el.textContent = (lang==='it'?'DifficoltÃ  IA':'AI Difficulty');
  }

  // Types & utils
  var OBJ_TYPES = ['Rosso','Nero','Pari','Dispari','Alto','Basso'];
  var ICON_OBJ = { 'Rosso':'ğŸ”´','Nero':'âš«','Pari':'2ï¸âƒ£','Dispari':'1ï¸âƒ£','Alto':'â¬†','Basso':'â¬‡' };
  function rnd(n){ return Math.floor(Math.random()*n); }
  function shuffle(a){ a=[].concat(a); for(var i=a.length-1;i>0;i--){var j=rnd(i+1); var t=a[i]; a[i]=a[j]; a[j]=t;} return a; }
  function colorFor(n){ var block = Math.floor((n-1)/2); return block % 2 === 0 ? 'red' : 'black'; }
  function isHigh(n){ return n>=21; }
  function isEven(n){ return n%2===0; }

  // Decks - FIXED: Added 1 more 000 (3 total) and 1 more 00 (7 total)
  function buildZeroDeck(){
    var arr = [];
    // 000: 3 Ã— MAX (tier 3) - INCREASED from 2 to 3
    arr.push({kind:'zero', target:'MAX', tier:3, display:'000'});
    arr.push({kind:'zero', target:'MAX', tier:3, display:'000'});
    arr.push({kind:'zero', target:'MAX', tier:3, display:'000'});
    // 00: 7 Ã— MIN (tier 2) - INCREASED from 6 to 7
    for(var i=0;i<7;i++){ arr.push({kind:'zero', target:'MIN', tier:2, display:'00'}); }
    // 0: 4 Ã— MAX (tier 1) and 4 Ã— YOU (tier 1)
    for(var j=0;j<4;j++){ arr.push({kind:'zero', target:'MAX', tier:1, display:'0'}); }
    for(var k=0;k<4;k++){ arr.push({kind:'zero', target:'YOU', tier:1, display:'0'}); }
    return shuffle(arr);
  }
  function buildSpecialDeck(){
    var arr = [];
    for(var i=0;i<3;i++){ arr.push({kind:'special', effect:'remove_zero', display:'R0'}); }
    for(var j=0;j<3;j++){ arr.push({kind:'special', effect:'raise_cap', display:'+L'}); }
    // nuove carte blu: 2Ã— Order â–² e 2Ã— Order â–¼
    for(var u=0;u<2;u++){ arr.push({kind:'special', effect:'order_up', display:'â–²'}); }
    for(var d=0;d<2;d++){ arr.push({kind:'special', effect:'order_down', display:'â–¼'}); }
    return shuffle(arr);
  }
  function buildNumberDeck(){ var arr=[]; for(var i=1;i<=40;i++){ arr.push({kind:'number', value:i, color:colorFor(i), isHigh:isHigh(i), isEven:isEven(i), display:String(i)}); } return arr; }
  function buildMainDeck(){ return shuffle(buildNumberDeck().concat(buildZeroDeck()).concat(buildSpecialDeck())); }
  function buildObjectiveDeck(){ var arr=[]; for(var idx=0; idx<OBJ_TYPES.length; idx++){ var t=OBJ_TYPES[idx]; for(var i=0;i<4;i++) arr.push({type:t}); } return shuffle(arr); }

  // State
  var state = {
    round: 1,
    active: 0,
    deck: [],
    market: [],
    players: [],
    objDeck: [],
    log: [],
    pendingObjectiveChoice: null,
    lastZeroRecipient: null,
    lastEventWasZero: false,
    heldZeros: [],
    totalDeck: 0
  };

  function log(msg){ state.log.unshift('R'+state.round+' â€º '+msg); renderLog(); }

  // Lobby
  var inputsEl = null;
  function ensureInputs(){ if(!inputsEl) inputsEl = document.getElementById('playersInputs'); }
  function addPlayer(name){
    ensureInputs();
    var wrap = document.createElement('div');
    wrap.className = 'panel';
    var row = document.createElement('div'); row.className='row'; row.style.alignItems='center';

    var input = document.createElement('input');
    input.style.flex = '1'; input.style.padding = '.6rem'; input.style.borderRadius = '10px'; input.style.border = '0'; input.style.background = 'rgba(255,255,255,.12)'; input.style.color = '#fff';
    input.value = name || ('Player ' + (inputsEl.querySelectorAll('input').length+1));

    var del = document.createElement('button');
    del.type='button'; del.className='btn btn-danger'; del.textContent='âœ–';
    del.addEventListener('click', function(){ wrap.remove(); });

    row.appendChild(input); row.appendChild(del);
    wrap.appendChild(row); inputsEl.appendChild(wrap);
  }

  function startGame(){
    var playerName = document.getElementById('playerNameInput').value.trim() || 'You';
    var aiCount = parseInt(document.getElementById('aiCountSelect').value) || 1;
    var difficulty = document.getElementById('difficultySelect').value || 'easy';
    
    // Creare giocatore umano
    state.players = [{ 
      name: playerName, 
      line: [], 
      objectives: [], 
      jackpot: 1, 
      zeroPoints: 0, 
      exploded: false, 
      stopped: false, 
      roundScore: 0, 
      totalScore: 0, 
      maxNumbers: 10,
      isAI: false,
      difficulty: null
    }];
    
    // Aggiungere avversari AI
    var aiNames = ['Alice', 'Bob', 'Charlie'];
    for(var i = 0; i < aiCount; i++){
      state.players.push({ 
        name: aiNames[i], 
        line: [], 
        objectives: [], 
        jackpot: 1, 
        zeroPoints: 0, 
        exploded: false, 
        stopped: false, 
        roundScore: 0, 
        totalScore: 0, 
        maxNumbers: 10,
        isAI: true,
        difficulty: difficulty
      });
    }
    
    state.round = 1; 
    state.active = 0; 
    state.deck = buildMainDeck(); 
    state.objDeck = buildObjectiveDeck();
    state.market = []; 
    state.heldZeros = []; 
    state.lastZeroRecipient = null; 
    state.lastEventWasZero = false; 
    state.totalDeck = state.deck.length;

    document.getElementById('lobby').classList.add('hidden');
    document.getElementById('game').classList.remove('hidden');

    refillMarketPhase(); 
    renderAll();
    log((lang==='it'?'Partita iniziata: ':'Game started: ') + state.players.map(function(p){ return p.name + (p.isAI ? ' (IA)' : ''); }).join(', '));
  }

  // Helpers & eligibility
  function lastNumberInLine(p){ for(var k=p.line.length-1;k>=0;k--){ var c=p.line[k]; if(c.kind==='number') return c.value; } return -1; }
  function numberCount(p){ var cnt=0; for(var i=0;i<p.line.length;i++){ if(p.line[i].kind==='number') cnt++; } return cnt; }
  function flashZeroToast(text){ var t=document.getElementById('zeroToast'); t.textContent=text; t.style.display='block'; setTimeout(function(){ t.style.display='none'; }, 1200); }
  function eligibleIndices(){ var arr=[]; state.players.forEach(function(p,i){ if(!p.stopped && !p.exploded) arr.push(i); }); return arr; }
  function allEligibleHaveAtLeastOneNumber(){ var elig=eligibleIndices(); if(elig.length===0) return false; return elig.every(function(i){ return state.players[i].line.some(function(c){return c.kind==='number';}); }); }
  function hasZeroAsLastCard(p){ if(p.line.length === 0) return false; return p.line[p.line.length-1].kind === 'zero'; }

  // Zero assignment (unchanged except protections)
  function assignZero(z){
    var elig = eligibleIndices();
    if(elig.length===0){ state.heldZeros.push(z); return; }
    if(!allEligibleHaveAtLeastOneNumber()){ state.heldZeros.push(z); return; }

    var excludeIdx = (state.lastEventWasZero && state.lastZeroRecipient!=null && elig.length>1) ? state.lastZeroRecipient : null;

    function tieBreakClockwise(indices){
      var best=null, bestStep=Infinity, N=state.players.length;
      for(var ii=0; ii<indices.length; ii++){
        var i = indices[ii];
        var step = (i - state.active + N) % N;
        if(step<bestStep){ bestStep=step; best=i; }
      }
      return best;
    }

    function pickByLast(mode){
      var bestVal=null, cands=[];
      for(var m=0;m<elig.length;m++){
        var i = elig[m]; if(excludeIdx===i) continue;
        if(hasZeroAsLastCard(state.players[i])) continue; // skip if last is zero
        var v = lastNumberInLine(state.players[i]);
        if(bestVal===null || (mode==='max' ? v>bestVal : v<bestVal)){ bestVal=v; cands=[i]; }
        else if(v===bestVal){ cands.push(i); }
      }
      if(cands.length===0){ state.deck.push(z); state.deck = shuffle(state.deck); log(L[lang].logZeroBlocked(z.display, z.target, lang==='it'?'tutti hanno giÃ  una carta 0':'all have zero as last card')); return null; }
      return tieBreakClockwise(cands);
    }

    var idx = state.active;
    if(z.target==='MAX') idx = pickByLast('max');
    else if(z.target==='MIN') idx = pickByLast('min');
    else { // YOU
      if(excludeIdx===state.active && elig.length>1){ state.heldZeros.push(z); return; }
      if(hasZeroAsLastCard(state.players[state.active])) { state.deck.push(z); state.deck = shuffle(state.deck); log(L[lang].logZeroBlocked(z.display, z.target, lang==='it'?'giocatore ha giÃ  una carta 0':'player already has zero as last card')); return; }
      idx = elig.indexOf(state.active)>=0 ? state.active : elig[0];
    }

    if(idx === null) return; // zero was blocked

    var rec = state.players[idx];
    rec.line.push(z); rec.zeroPoints += z.tier; if(rec.zeroPoints>=6){ rec.exploded=true; rec.stopped=true; }
    var msg = L[lang].toastZero(z.display, z.target, rec.name, rec.zeroPoints, rec.exploded);
    log(msg); flashZeroToast(msg);
    state.lastZeroRecipient = idx; state.lastEventWasZero = true;
  }

  // Market refill: max 1 green per phase; reshuffle held after a nonâ€‘green appears
  function drawUntilNonZeroOnce(greenAssigned){
    var safety=0;
    while(state.deck.length>0 && safety<300){
      safety++;
      var top = state.deck.shift();
      if(top.kind==='zero'){
        if(greenAssigned){ state.heldZeros.push(top); continue; }
        assignZero(top); return true; // consumed a green in this phase
      } else {
        state.market.push(top); state.lastEventWasZero=false; return greenAssigned;
      }
    }
    return greenAssigned;
  }
  function refillMarketPhase(){
    var greenAssigned=false, safety=0, before=state.market.length;
    while(state.market.length<3 && state.deck.length>0 && safety<500){
      safety++; greenAssigned = drawUntilNonZeroOnce(greenAssigned) || greenAssigned;
    }
    var placedNonZero = state.market.length>before;
    if(placedNonZero && state.heldZeros.length>0){ Array.prototype.push.apply(state.deck, state.heldZeros); state.heldZeros=[]; state.deck=shuffle(state.deck); }
    updateDeckCount(); renderMarket(); maybeAutoEnd();
  }
  function updateDeckCount(){ var el=document.getElementById('deckCount'); if(!el) return; el.textContent = state.deck.length + ' / ' + state.totalDeck; }

  // Turn helpers
  function allStopped(){ return state.players && state.players.length > 0 && state.players.every(function(p){ return p.stopped; }); }
  function nextActive(){ 
    if(!state || !state.players || state.players.length === 0) return false;
    for(var step=1; step<=state.players.length; step++){ 
      var idx=(state.active+step)%state.players.length; 
      if(state.players[idx] && !state.players[idx].stopped){ 
        state.active=idx; 
        // Se Ã¨ un bot, esegui la mossa automaticamente dopo un delay
        if(state.players[idx] && state.players[idx].isAI){
          setTimeout(function(){ 
            if(state && state.players && state.active < state.players.length){
              makeAIMove(); 
            }
          }, 800);
        }
        return true; 
      } 
    } 
    return false; 
  }
  function maybeAutoEnd(){ 
    if(allStopped() || (state && state.deck && state.deck.length === 0)){ 
      endRound(); 
      return true; 
    } 
    return false; 
  }

  function makeAIMove(){
    if(!state || !state.players || state.active >= state.players.length) return;
    
    var p = state.players[state.active];
    if(!p || !p.isAI) return;
    if(p.stopped || p.exploded) { nextActive(); renderAll(); return; }
    
    var shouldStop = evaluateAIDecision(p);
    if(shouldStop){
      stopPlayer();
    } else {
      // Scegliere quale carta prendere
      var bestIdx = selectBestCard(p);
      if(bestIdx >= 0 && bestIdx < state.market.length){
        pickMarket(bestIdx);
      } else {
        stopPlayer();
      }
    }
  }
  
  function evaluateAIDecision(p){
    if(!p) return true;
    var threshold = (p.difficulty === 'easy') ? 5 : 6;
    var cardsUntilLimit = (p.maxNumbers || 10) - numberCount(p);
    var deckRatio = state.deck.length / Math.max(1, state.totalDeck);
    
    if(p.difficulty === 'easy'){
      if(p.jackpot >= threshold) return true;
      if(cardsUntilLimit <= 1) return true;
      if(deckRatio < 0.15 && p.jackpot >= 2) return true;
      return false;
    } else { // hard
      var riskScore = 0;
      if(p.jackpot >= threshold) riskScore += 3;
      if(cardsUntilLimit <= 1) riskScore += 3;
      if(deckRatio < 0.2) riskScore += 2;
      if(p.objectives && p.objectives.length >= 2) riskScore -= 1;
      return riskScore >= 5;
    }
  }
  
  function selectBestCard(p){
    if(!p || state.market.length === 0) return -1;
    
    var cardsUntilLimit = (p.maxNumbers || 10) - numberCount(p);
    
    var scores = state.market.map(function(card, idx){
      var score = 0;
      
      if(card.kind === 'special'){
        if(card.effect === 'raise_cap'){
          score = cardsUntilLimit <= 2 ? 100 : 30;
        } else if(card.effect === 'remove_zero'){
          score = p.zeroPoints >= 4 ? 80 : 10;
        } else {
          score = 5;
        }
      } else if(card.kind === 'zero'){
        score = 20;
      } else if(card.kind === 'number'){
        // Preferire numeri che matchano gli obiettivi
        var objectiveMatches = 0;
        if(p.objectives && p.objectives.length > 0){
          p.objectives.forEach(function(obj){
            if(matchesObjectiveAI(card, obj)) objectiveMatches++;
          });
        }
        score = objectiveMatches > 0 ? 50 + objectiveMatches * 20 : 15;
        
        // Preferire numeri neri (non aprono la modal scelta obiettivo)
        if(card.color === 'black') score += 10;
      }
      
      return score;
    });
    
    var maxScore = Math.max.apply(null, scores);
    var bestIndices = [];
    scores.forEach(function(s, i){ if(s === maxScore) bestIndices.push(i); });
    
    return bestIndices[Math.floor(Math.random() * bestIndices.length)];
  }
  
  function matchesObjectiveAI(card, objType){
    if(!card || card.kind !== 'number') return false;
    if(!objType) return false;
    if(objType === 'Rosso') return card.color === 'red';
    if(objType === 'Nero') return card.color === 'black';
    if(objType === 'Pari') return card.value % 2 === 0;
    if(objType === 'Dispari') return card.value % 2 === 1;
    if(objType === 'Basso') return card.value <= 20;
    if(objType === 'Alto') return card.value > 20;
    return false;
  }
  
  function makeAIObjectiveChoice(){
    var p = state.players[state.active];
    if(!p.isAI) return;
    
    var choices = document.querySelectorAll('#objChoices .btn');
    if(choices.length === 0) return;
    
    // Scegliere un obiettivo casuale (potrebbe essere piÃ¹ intelligente)
    var chosenIdx = Math.floor(Math.random() * choices.length);
    chooseGoal(chosenIdx);
  }

  // Actions
  function pickMarket(i){
    if(!state || !state.players || state.active >= state.players.length) return;
    if(state.players[state.active].stopped){ if(nextActive()) renderAll(); return; }
    var card = state.market.splice(i,1)[0]; 
    var p = state.players[state.active];
    if(!p || !card) return;
    if(card.kind==='number'){
      p.line.push(card); state.lastEventWasZero=false;
      if(card.color==='black'){ p.jackpot+=1; log(L[lang].logPickBlack(p.name, card.value, p.jackpot)); }
      else { log(L[lang].logPickRed(p.name, card.value)); openObjectiveChoices(numberCount(p) >= (p.maxNumbers||10)); }
      if(card.color==='black' && numberCount(p) >= (p.maxNumbers||10)){
        p.stopped=true;
        log(lang==='it' ? ('â„¹ '+p.name+' raggiunge '+(p.maxNumbers||10)+' carte: stop automatico') : ('â„¹ '+p.name+' reaches '+(p.maxNumbers||10)+' cards: auto-stop'));
      }
    } else if(card.kind==='special'){
      p.line.push(card);
      if(card.effect==='remove_zero'){
        var removedTier = 0, foundIndex=-1;
        for(var k=p.line.length-2;k>=0;k--){ var c=p.line[k]; if(c.kind==='zero'){ removedTier=c.tier; foundIndex=k; break; } }
        if(foundIndex>=0){
          var z=p.line.splice(foundIndex,1)[0];
          p.zeroPoints=Math.max(0,p.zeroPoints-removedTier);
          state.deck.push(z); state.deck=shuffle(state.deck); updateDeckCount();
          log(L[lang].logRemoveZero(p.name, (lang==='it'?L.it.specialR0:L.en.specialR0), removedTier));
        } else { log(L[lang].logNoZeroToRemove(p.name, (lang==='it'?L.it.specialR0:L.en.specialR0))); }
      } else if(card.effect==='raise_cap'){
        p.maxNumbers=(p.maxNumbers||10)+1;
        log(L[lang].logRaiseCap(p.name, p.maxNumbers));
      } else if(card.effect==='order_up' || card.effect==='order_down'){
        var label = (card.effect==='order_up' ? (lang==='it'?L.it.specialUp:L.en.specialUp) : (lang==='it'?L.it.specialDown:L.en.specialDown));
        log(p.name + ' ' + (lang==='it' ? 'prende' : 'takes') + ' ' + label);
      }
      // end of special
    }
    refillMarketPhase();
    setTimeout(function(){ if(!isObjModalOpen()){ if(!maybeAutoEnd()){ nextActive(); renderAll(); } } else { renderAll(); } }, 10);
  }
  function stopPlayer(){ 
    if(!state || !state.players || state.active >= state.players.length) return;
    var p=state.players[state.active]; 
    if(!p || p.stopped) return; 
    p.stopped=true; 
    log(L[lang].logStop(p.name)); 
    if(!maybeAutoEnd()){ nextActive(); renderAll(); } 
  }

  // Objectives
  function isObjModalOpen(){ return document.getElementById('objModal').style.display==='flex'; }
  function openObjectiveChoices(willBeAtLimit){
    if(!state || !state.players) return;
    state.pendingObjectiveChoice=state.active; if(state.objDeck.length<3) state.objDeck=buildObjectiveDeck();
    var opts=state.objDeck.splice(0,3); var box=document.getElementById('objChoices'); if(!box) return; box.innerHTML='';
    opts.forEach(function(o,idx){
      var btn=document.createElement('button'); btn.className='btn btn-secondary';
      btn.textContent=(ICON_OBJ[o.type]||'ğŸ¯')+' '+tObj(o.type);
      btn.addEventListener('click',function(){
        var p=state.players[state.pendingObjectiveChoice];
        if(!p || !p.objectives) return;
        var need=2 + p.objectives.length;
        p.objectives.push(o.type); log(L[lang].logGainObj(p.name, tObj(o.type), need));
        opts.forEach(function(x,j){ if(j!==idx) state.objDeck.push(x); });
        closeObjectiveChoices();
        if(willBeAtLimit){ p.stopped=true; log(lang==='it' ? ('â„¹ '+p.name+' raggiunge '+(p.maxNumbers||10)+' carte: stop automatico') : ('â„¹ '+p.name+' reaches '+(p.maxNumbers||10)+' cards: auto-stop')); }
        if(!maybeAutoEnd()){ nextActive(); }
        renderAll();
      });
      box.appendChild(btn);
    });
    openModal('objModal');
    
    // Se Ã¨ un bot, far scegliere automaticamente
    if(state.players && state.players[state.active] && state.players[state.active].isAI){
      setTimeout(function(){
        var buttons = document.querySelectorAll('#objChoices .btn');
        if(buttons.length > 0){
          var randomBtn = buttons[Math.floor(Math.random() * buttons.length)];
          randomBtn.click();
        }
      }, 600);
    }
  }
  function closeObjectiveChoices(){ closeModal('objModal'); state.pendingObjectiveChoice=null; }

  // Scoring & Rounds - Added order bonus calculation
  function countMatches(cards, type){
    if(!cards || !type) return 0;
    if(type==='Rosso') return cards.filter(function(c){return c.kind==='number' && c.color==='red';}).length;
    if(type==='Nero')  return cards.filter(function(c){return c.kind==='number' && c.color==='black';}).length;
    if(type==='Pari')  return cards.filter(function(c){return c.kind==='number' && c.isEven;}).length;
    if(type==='Dispari')return cards.filter(function(c){return c.kind==='number' && !c.isEven;}).length;
    if(type==='Alto')  return cards.filter(function(c){return c.kind==='number' && c.isHigh;}).length;
    if(type==='Basso') return cards.filter(function(c){return c.kind==='number' && !c.isHigh;}).length;
    return 0;
  }
  function activeObjectives(p){ 
    if(!p || !p.objectives) return 0;
    var a=0; 
    for(var i=0;i<p.objectives.length;i++){ 
      var need=2+i; 
      var have=countMatches(p.line,p.objectives[i]); 
      if(have>=need) a++; 
    } 
    return a; 
  }
  
  function calculateOrderBonus(p){
    if(!p || !p.line) return 0;
    var bonus = 0;
    for(var i = 0; i < p.line.length; i++){
      var card = p.line[i];
      if(card.kind === 'special' && (card.effect === 'order_up' || card.effect === 'order_down')){
        // Find the last number before this order card
        var lastNum = null;
        for(var j = i - 1; j >= 0; j--){
          if(p.line[j].kind === 'number'){
            lastNum = p.line[j].value;
            break;
          }
        }
        if(lastNum === null) continue; // No number before order card
        
        // Count sequence after order card
        var sequenceBonus = 0;
        var currentNum = lastNum;
        var isAscending = card.effect === 'order_up';
        
        for(var k = i + 1; k < p.line.length; k++){
          if(p.line[k].kind === 'number'){
            var nextNum = p.line[k].value;
            var correctOrder = isAscending ? (nextNum > currentNum) : (nextNum < currentNum);
            if(correctOrder){
              sequenceBonus += 2; // 2 points per correct card in sequence
              currentNum = nextNum;
            } else {
              break; // Sequence broken, stop counting
            }
          }
        }
        bonus += sequenceBonus;
      }
    }
    return bonus;
  }
  function endRound(){
    if(!state || !state.players) return;
    var list=[];
    state.players.forEach(function(p){
      var act=activeObjectives(p); 
      var orderBonus = calculateOrderBonus(p);
      var baseScore = p.jackpot * act;
      var totalScore = baseScore + orderBonus;
      if(p.exploded) totalScore = Math.floor(totalScore / 2);
      
      p.roundScore = totalScore; 
      p.totalScore += totalScore; 
      list.push({
        name: p.name,
        round: totalScore,
        base: baseScore,
        orderBonus: orderBonus,
        total: p.totalScore
      });
      
      // Log order bonus if any
      if(orderBonus > 0){
        log((lang==='it'? (p.name + ' ottiene ' + orderBonus + ' punti bonus ordine') : (p.name + ' gets ' + orderBonus + ' order bonus points')));
      }
      
      // RESET
      p.jackpot=0; p.objectives=[]; p.zeroPoints=0; p.line=[]; p.exploded=false; p.stopped=false; p.maxNumbers=10;
    });
    openSummary(list);
  }
  function openSummary(list){
    if(!state || !list) return;
    var s=document.getElementById('summaryList');
    if(!s) return;
    s.innerHTML=list.map(function(x){ 
      var details = '';
      if(x.orderBonus > 0){
        details = ' (Base: ' + x.base + ' + Order: ' + x.orderBonus + ')';
      }
      return '<div class="panel" style="margin:8px 0"><div style="display:flex;justify-content:space-between"><b>'+x.name+'</b><span>Round: <b>'+x.round+'</b>'+details+' â€¢ Total: <b>'+x.total+'</b></span></div></div>'; 
    }).join('');
    openModal('summaryModal'); 
    var titleEl = document.getElementById('summaryTitle');
    if(titleEl) titleEl.textContent=L[lang].roundEnd;
    var nextBtn=document.getElementById('nextRoundBtn'); 
    var newBtn=document.getElementById('newGameBtn');
    if(nextBtn && newBtn){
      if(state.round>=3){ nextBtn.classList.add('hidden'); newBtn.classList.remove('hidden'); }
      else { nextBtn.classList.remove('hidden'); newBtn.classList.add('hidden'); }
    }
  }
  function nextRound(){
    if(!state || !state.players) return;
    closeModal('summaryModal');
    state.round+=1; state.active=0; state.deck=buildMainDeck(); state.objDeck=buildObjectiveDeck(); state.market=[]; state.lastZeroRecipient=null; state.lastEventWasZero=false; state.heldZeros=[]; state.totalDeck=state.deck.length;
    // Leaderboard-based jackpot bonus
    var maxScore = Math.max.apply(Math, state.players.map(function(p){ return p.totalScore; }));
    state.players.forEach(function(p){
      var pointsGap = maxScore - p.totalScore;
      var bonusCoins = Math.min(3, Math.floor(pointsGap / 10));
      p.jackpot = 1 + bonusCoins;
      if(bonusCoins > 0){ log((lang==='it'? (p.name + ' parte con ' + p.jackpot + ' monete (gap: ' + pointsGap + ' punti)') : (p.name + ' starts with ' + p.jackpot + ' coins (gap: ' + pointsGap + ' points)'))); }
    });
    refillMarketPhase();
    renderAll();
  }

  // Rendering
  function renderAll(){ 
    if(!state || !state.players) return;
    document.getElementById('roundEl').textContent=state.round; 
    if(state.players[state.active]) document.getElementById('activeName').textContent=state.players[state.active].name; 
    renderPlayers(); 
    renderMarket(); 
    updateDeckCount(); 
  }
  function renderPlayers(){
    if(!state || !state.players) return;
    var area=document.getElementById('playersArea'); 
    if(!area) return;
    area.innerHTML='';
    state.players.forEach(function(p,idx){
      var div=document.createElement('div'); var cls=['player']; if(idx===state.active) cls.push('current'); if(p.exploded) cls.push('exploded'); if(p.stopped) cls.push('stopped'); div.className=cls.join(' ');
      var noneCards=(L[lang].cardsLbl==='Cards'?'None':'Nessuna'); var noneObjs=(L[lang].objsLbl==='Goals'?'None':'Nessuno');

      var nameRow=document.createElement('div'); nameRow.className='row'; nameRow.style.alignItems='center'; nameRow.style.justifyContent='space-between';
      var nameEl=document.createElement('div'); nameEl.className='name'; nameEl.innerHTML = p.name+(p.isAI?' <span style="font-size:.75rem;background:#9333ea;padding:.2rem .4rem;border-radius:4px;margin-left:6px">'+(p.difficulty==='easy'?'IA Easy':'IA Hard')+'</span>':'')+(p.stopped?' â€” <span style="color:#fde68a">STOP</span>':'')+(p.exploded?' â€” <span style="color:#fecaca">ğŸ’¥</span>':'');
      var stats=document.createElement('div'); stats.innerHTML = '<span class="stat">ğŸ’° '+p.jackpot+'</span>'+
        '<span class="stat" title="'+(lang==='it'?'Limite carte':'Card limit')+'">ğŸ”¢ '+(p.maxNumbers||10)+'</span>'+
        '<span class="stat">âš¡ '+p.zeroPoints+'/6</span>'+
        '<span class="stat">â­ '+activeObjectives(p)+'</span>'+
        '<span class="stat">ğŸ† '+p.totalScore+'</span>';
      nameRow.appendChild(nameEl); nameRow.appendChild(stats);

      var cardsTitle=document.createElement('div'); cardsTitle.innerHTML='<b>'+L[lang].cardsLbl+':</b>';
      var cardsBox=document.createElement('div'); cardsBox.className='mini'; cardsBox.style.marginTop='4px';
      if(p.line.length){
        p.line.forEach(function(c){
          var sp=document.createElement('span'); sp.className='pill';
          if(c.kind==='number') sp.textContent=(c.color==='red'?'ğŸ”´ ':'âš« ')+c.value;
          else if(c.kind==='zero') sp.textContent='ğŸ’š '+c.target+' '+Array(c.tier+1).join('â€¢');
          else {
            var label;
            if (c.effect==='remove_zero') label = (lang==='it'?L.it.specialR0:L.en.specialR0);
            else if (c.effect==='raise_cap') label = (lang==='it'?L.it.specialCap:L.en.specialCap);
            else if (c.effect==='order_up') label = (lang==='it'?L.it.specialUp:L.en.specialUp);
            else if (c.effect==='order_down') label = (lang==='it'?L.it.specialDown:L.en.specialDown);
            else label = 'ğŸ”·';
            sp.textContent = label;
          }
          cardsBox.appendChild(sp);
        });
      } else { cardsBox.innerHTML='<span style="opacity:.6">'+noneCards+'</span>'; }

      var objsTitle=document.createElement('div'); objsTitle.innerHTML='<b>'+L[lang].objsLbl+':</b>';
      var objsBox=document.createElement('div'); objsBox.className='mini'; objsBox.style.marginTop='4px';
      if(p.objectives && p.objectives.length){
        p.objectives.forEach(function(t,i){ var sp=document.createElement('span'); sp.className='pill'; sp.textContent=(ICON_OBJ[t]||'ğŸ¯')+' '+tObj(t)+' (â‰¥'+(2+i)+')'; objsBox.appendChild(sp); });
      } else { objsBox.innerHTML='<span style="opacity:.6">'+noneObjs+'</span>'; }

      div.appendChild(nameRow);
      div.appendChild(document.createElement('div')).style.height='6px';
      div.appendChild(cardsTitle);
      div.appendChild(cardsBox);
      div.appendChild(document.createElement('div')).style.height='8px';
      div.appendChild(objsTitle);
      div.appendChild(objsBox);
      area.appendChild(div);
    });
  }
  function renderMarket(){
    if(!state || !state.market) return;
    var m=document.getElementById('market'); 
    if(!m) return;
    m.innerHTML='';
    state.market.forEach(function(c,i){
      var b=document.createElement('button'); b.className='card'; b.addEventListener('click', function(){ pickMarket(i); });
      if(c.kind==='number'){
        b.innerHTML = '<div class="ico">'+(c.color==='red'?'ğŸ”´':'âš«')+'</div><div class="val">'+c.value+'</div>';
      } else if(c.kind==='zero'){
        b.innerHTML = '<div class="ico">ğŸ’š</div><div class="val">'+c.display+' '+c.target+'</div>';
      } else { // special
        var label;
        if (c.effect==='remove_zero') label = (lang==='it'?L.it.specialR0:L.en.specialR0);
        else if (c.effect==='raise_cap') label = (lang==='it'?L.it.specialCap:L.en.specialCap);
        else if (c.effect==='order_up') label = (lang==='it'?L.it.specialUp:L.en.specialUp);
        else if (c.effect==='order_down') label = (lang==='it'?L.it.specialDown:L.en.specialDown);
        else label = 'ğŸ”·';
        b.innerHTML = '<div class="ico">ğŸ”·</div><div class="val">'+label+'</div>';
      }
      m.appendChild(b);
    });
  }
  function renderLog(){ 
    if(!state || !state.log) return;
    var l=document.getElementById('log'); 
    if(!l) return;
    l.innerHTML=state.log.map(function(x){ return '<div style="padding:4px 0">'+x+'</div>'; }).join(''); 
  }

  // Modals
  function openModal(id){ 
    var overlay = document.getElementById('overlay');
    if(!overlay) return;
    overlay.style.display='block'; 
    var el=document.getElementById(id); 
    if(el) el.style.display='flex'; 
  }
  function closeModal(id){ 
    var overlay = document.getElementById('overlay');
    if(!overlay) return;
    overlay.style.display='none'; 
    var el=document.getElementById(id); 
    if(el) el.style.display='none'; 
  }

  // Boot
  document.addEventListener('DOMContentLoaded', function(){
    document.getElementById('btnStart').addEventListener('click', function(){ startGame(); });
    document.getElementById('btnStop').addEventListener('click', function(){ stopPlayer(); });
    document.getElementById('btnEndRound').addEventListener('click', function(){ endRound(); });
    document.getElementById('nextRoundBtn').addEventListener('click', function(){ nextRound(); });
    Array.prototype.forEach.call(document.querySelectorAll('input[name="lang"]'), function(r){ r.addEventListener('change', function(e){ lang=e.target.value; setTexts(); renderAll(); }); });
    setTexts();
  });
  </script>
</body>
</html>
